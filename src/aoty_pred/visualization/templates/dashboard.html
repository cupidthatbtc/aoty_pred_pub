{% extends "base.html" %}

{% block title %}{{ title|default('AOTY Model Dashboard') }}{% endblock %}

{% block body %}
<div class="app-container">
    {% include "components/sidebar.html" %}

    <main class="main-content">
        {% include "components/header.html" %}

        <div class="dashboard-content">
            {% if active_view == 'overview' %}
            {# Overview shows all available charts #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Model Overview
            </h2>

            {% if 'predictions' in figures %}
            <div class="chart-container" id="predictions-chart">
                <div class="chart-header">
                    <span class="chart-title">Predicted vs Actual Scores</span>
                    <a href="/export/predictions?format=png" class="btn">Download</a>
                </div>
                {{ figures['predictions'] | safe }}
            </div>
            {% endif %}

            {% if 'coefficients' in figures %}
            <div class="chart-container" id="coefficients-chart">
                <div class="chart-header">
                    <span class="chart-title">Coefficient Estimates</span>
                    <a href="/export/coefficients?format=png" class="btn">Download</a>
                </div>
                {{ figures['coefficients'] | safe }}
            </div>
            {% endif %}

            {% if 'reliability' in figures %}
            <div class="chart-container" id="reliability-chart">
                <div class="chart-header">
                    <span class="chart-title">Calibration Diagram</span>
                    <a href="/export/reliability?format=png" class="btn">Download</a>
                </div>
                {{ figures['reliability'] | safe }}
            </div>
            {% endif %}

            {% elif active_view == 'trace' %}
            {# Diagnostics view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                MCMC Diagnostics
            </h2>

            {% if 'trace' in figures %}
            <div class="chart-container" id="trace-chart">
                <div class="chart-header">
                    <span class="chart-title">Trace Plots</span>
                    <a href="/export/trace?format=png" class="btn">Download</a>
                </div>
                {{ figures['trace'] | safe }}
            </div>
            {% else %}
            <div class="not-found">
                No inference data available for diagnostics.
            </div>
            {% endif %}

            {% elif active_view == 'predictions' %}
            {# Predictions view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Model Predictions
            </h2>

            {% if 'predictions' in figures %}
            <div class="chart-container" id="predictions-chart">
                <div class="chart-header">
                    <span class="chart-title">Predicted vs Actual Scores</span>
                    <a href="/export/predictions?format=png" class="btn">Download</a>
                </div>
                {{ figures['predictions'] | safe }}
            </div>
            {% else %}
            <div class="not-found">
                No prediction data available.
            </div>
            {% endif %}

            {% elif active_view == 'coefficients' %}
            {# Coefficients view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Model Coefficients
            </h2>

            {% if 'coefficients' in figures %}
            <div class="chart-container" id="coefficients-chart">
                <div class="chart-header">
                    <span class="chart-title">Coefficient Forest Plot</span>
                    <a href="/export/coefficients?format=png" class="btn">Download</a>
                </div>
                {{ figures['coefficients'] | safe }}
            </div>

            {% if coefficients_table %}
            <div class="chart-container" id="coefficients-table">
                <div class="chart-header">
                    <span class="chart-title">Coefficient Table</span>
                </div>
                {{ coefficients_table | safe }}
            </div>
            {% endif %}
            {% else %}
            <div class="not-found">
                No coefficient data available.
            </div>
            {% endif %}

            {% elif active_view == 'reliability' %}
            {# Calibration view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Model Calibration
            </h2>

            {% if 'reliability' in figures %}
            <div class="chart-container" id="reliability-chart">
                <div class="chart-header">
                    <span class="chart-title">Reliability Diagram</span>
                    <a href="/export/reliability?format=png" class="btn">Download</a>
                </div>
                {{ figures['reliability'] | safe }}
            </div>
            {% else %}
            <div class="not-found">
                No calibration data available.
            </div>
            {% endif %}

            {% elif active_view == 'artist' %}
            {# Artist-specific view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Artist: {{ artist_name }}
            </h2>

            {% if artist_chart %}
            <div class="chart-container" id="artist-chart">
                <div class="chart-header">
                    <span class="chart-title">Album Score History</span>
                    <a href="/export/artist/{{ artist_name }}?format=png" class="btn">Download</a>
                </div>
                {{ artist_chart | safe }}
            </div>
            {% else %}
            <div class="not-found">
                Artist "{{ artist_name }}" not found in data.
            </div>
            {% endif %}

            {% else %}
            {# Default fallback #}
            <div class="not-found">
                Select a view from the sidebar.
            </div>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Table sorting functionality
    document.querySelectorAll('.coefficient-table th').forEach(function(header) {
        header.addEventListener('click', function() {
            const table = this.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const columnIndex = Array.from(this.parentNode.children).indexOf(this);
            const sortType = this.dataset.sort || 'string';

            // Determine sort direction
            const currentDir = this.dataset.sortDir || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';

            // Reset all headers
            table.querySelectorAll('th').forEach(h => h.dataset.sortDir = '');
            this.dataset.sortDir = newDir;

            // Sort rows
            rows.sort(function(a, b) {
                const cellA = a.children[columnIndex];
                const cellB = b.children[columnIndex];

                let valueA, valueB;

                if (sortType === 'number') {
                    valueA = parseFloat(cellA.dataset.value || cellA.textContent);
                    valueB = parseFloat(cellB.dataset.value || cellB.textContent);
                } else {
                    valueA = cellA.textContent.toLowerCase();
                    valueB = cellB.textContent.toLowerCase();
                }

                if (valueA < valueB) return newDir === 'asc' ? -1 : 1;
                if (valueA > valueB) return newDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Re-append sorted rows
            rows.forEach(function(row) {
                tbody.appendChild(row);
            });
        });
    });
</script>
{% endblock %}
