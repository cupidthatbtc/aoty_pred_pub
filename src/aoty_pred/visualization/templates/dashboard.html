{% extends "base.html" %}

{% block title %}{{ title|default('AOTY Model Dashboard') }}{% endblock %}

{% block body %}
<div class="app-container">
    {% include "components/sidebar.html" %}

    <main class="main-content">
        {% include "components/header.html" %}

        <div class="dashboard-content">
            {% if active_view == 'overview' %}
            {# Overview shows all available charts #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Model Overview
            </h2>

            {% if eval_metrics %}
            <div class="chart-container" id="metrics-summary">
                <div class="chart-header">
                    <span class="chart-title">Model Performance</span>
                </div>
                <div class="metrics-grid">
                    {% if eval_metrics['point_metrics'] %}
                    {% if eval_metrics['point_metrics']['r2'] is not none %}
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.3f"|format(eval_metrics['point_metrics']['r2']) }}</div>
                        <div class="metric-label">R-squared</div>
                    </div>
                    {% endif %}
                    {% if eval_metrics['point_metrics']['rmse'] is not none %}
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.2f"|format(eval_metrics['point_metrics']['rmse']) }}</div>
                        <div class="metric-label">RMSE</div>
                    </div>
                    {% endif %}
                    {% if eval_metrics['point_metrics']['mae'] is not none %}
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.2f"|format(eval_metrics['point_metrics']['mae']) }}</div>
                        <div class="metric-label">MAE</div>
                    </div>
                    {% endif %}
                    {% endif %}
                    {% if eval_metrics['calibration'] %}
                    {% if eval_metrics['calibration']['coverage_90'] is not none %}
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.1f%%"|format(eval_metrics['calibration']['coverage_90'] * 100) }}</div>
                        <div class="metric-label">90% Coverage</div>
                    </div>
                    {% endif %}
                    {% if eval_metrics['calibration']['coverage_50'] is not none %}
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.1f%%"|format(eval_metrics['calibration']['coverage_50'] * 100) }}</div>
                        <div class="metric-label">50% Coverage</div>
                    </div>
                    {% endif %}
                    {% endif %}
                    {% if eval_metrics.get('crps') and eval_metrics['crps']['mean_crps'] is not none %}
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.3f"|format(eval_metrics['crps']['mean_crps']) }}</div>
                        <div class="metric-label">CRPS</div>
                    </div>
                    {% endif %}
                </div>
                <div class="metrics-meta" style="margin-top: 12px; font-size: 0.8rem; color: var(--text-muted);">
                    n = {{ eval_metrics['n_test'] }} test observations
                </div>
            </div>
            {% endif %}

            {% if 'predictions' in figures %}
            <div class="chart-container" id="predictions-chart">
                <div class="chart-header">
                    <span class="chart-title">Predicted vs Actual Scores</span>
                    <a href="/export/predictions?format=png" class="btn">Download</a>
                </div>
                {{ figures['predictions'] | safe }}
            </div>
            {% endif %}

            {% if 'coefficients' in figures %}
            <div class="chart-container" id="coefficients-chart">
                <div class="chart-header">
                    <span class="chart-title">Coefficient Estimates</span>
                    <a href="/export/coefficients?format=png" class="btn">Download</a>
                </div>
                {{ figures['coefficients'] | safe }}
            </div>
            {% endif %}

            {% if 'reliability' in figures %}
            <div class="chart-container" id="reliability-chart">
                <div class="chart-header">
                    <span class="chart-title">Calibration Diagram</span>
                    <a href="/export/reliability?format=png" class="btn">Download</a>
                </div>
                {{ figures['reliability'] | safe }}
            </div>
            {% endif %}

            {% elif active_view == 'trace' %}
            {# Diagnostics view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                MCMC Diagnostics
            </h2>

            {% if 'trace' in figures %}
            <div class="chart-container" id="trace-chart">
                <div class="chart-header">
                    <span class="chart-title">Trace Plots</span>
                    <a href="/export/trace?format=png" class="btn">Download</a>
                </div>
                {{ figures['trace'] | safe }}
            </div>
            {% else %}
            <div class="not-found">
                No inference data available for diagnostics.
            </div>
            {% endif %}

            {% elif active_view == 'predictions' %}
            {# Predictions view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Model Predictions
            </h2>

            {% if 'predictions' in figures %}
            <div class="chart-container" id="predictions-chart">
                <div class="chart-header">
                    <span class="chart-title">Predicted vs Actual Scores</span>
                    <a href="/export/predictions?format=png" class="btn">Download</a>
                </div>
                {{ figures['predictions'] | safe }}
            </div>
            {% else %}
            <div class="not-found">
                No prediction data available.
            </div>
            {% endif %}

            {% elif active_view == 'coefficients' %}
            {# Coefficients view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Model Coefficients
            </h2>

            {% if 'coefficients' in figures %}
            <div class="chart-container" id="coefficients-chart">
                <div class="chart-header">
                    <span class="chart-title">Coefficient Forest Plot</span>
                    <a href="/export/coefficients?format=png" class="btn">Download</a>
                </div>
                {{ figures['coefficients'] | safe }}
            </div>

            {% if coefficients_table %}
            <div class="chart-container" id="coefficients-table">
                <div class="chart-header">
                    <span class="chart-title">Coefficient Table</span>
                </div>
                {{ coefficients_table | safe }}
            </div>
            {% endif %}
            {% else %}
            <div class="not-found">
                No coefficient data available.
            </div>
            {% endif %}

            {% elif active_view == 'reliability' %}
            {# Calibration view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Model Calibration
            </h2>

            {% if eval_metrics and eval_metrics['calibration'] %}
            <div class="chart-container" id="calibration-metrics">
                <div class="chart-header">
                    <span class="chart-title">Calibration Metrics</span>
                </div>
                <div class="metrics-grid">
                    {% if eval_metrics['calibration']['coverage_90'] is not none %}
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.1f%%"|format(eval_metrics['calibration']['coverage_90'] * 100) }}</div>
                        <div class="metric-label">90% Coverage</div>
                    </div>
                    {% endif %}
                    {% if eval_metrics['calibration']['coverage_50'] is not none %}
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.1f%%"|format(eval_metrics['calibration']['coverage_50'] * 100) }}</div>
                        <div class="metric-label">50% Coverage</div>
                    </div>
                    {% endif %}
                    {% if eval_metrics['calibration'].get('interval_width_90') is not none %}
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.1f"|format(eval_metrics['calibration']['interval_width_90']) }}</div>
                        <div class="metric-label">90% Interval Width</div>
                    </div>
                    {% endif %}
                    {% if eval_metrics['calibration'].get('interval_width_50') is not none %}
                    <div class="metric-card">
                        <div class="metric-value">{{ "%.1f"|format(eval_metrics['calibration']['interval_width_50']) }}</div>
                        <div class="metric-label">50% Interval Width</div>
                    </div>
                    {% endif %}
                </div>
                <div class="metrics-meta" style="margin-top: 12px; font-size: 0.8rem; color: var(--text-muted);">
                    n = {{ eval_metrics['n_test'] }} test observations
                </div>
            </div>
            {% endif %}

            {% if 'reliability' in figures %}
            <div class="chart-container" id="reliability-chart">
                <div class="chart-header">
                    <span class="chart-title">Reliability Diagram</span>
                    <a href="/export/reliability?format=png" class="btn">Download</a>
                </div>
                {{ figures['reliability'] | safe }}
            </div>
            {% else %}
            <div class="not-found">
                No calibration data available.
            </div>
            {% endif %}

            {% elif active_view == 'next_albums' %}
            {# Next-album predictions view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Next-Album Predictions
            </h2>

            {% if next_album_tables %}
            {% if 'next_albums' in figures %}
            <div class="chart-container" id="next-albums-chart">
                <div class="chart-header">
                    <span class="chart-title">Prediction Distribution by Scenario</span>
                </div>
                {{ figures['next_albums'] | safe }}
            </div>
            {% endif %}

            <div class="chart-container" id="known-predictions">
                <div class="chart-header">
                    <span class="chart-title">Known Artist Predictions</span>
                </div>
                <div style="margin-bottom: 12px;">
                    <label for="scenario-filter" style="font-size: 0.875rem; color: var(--text-muted); margin-right: 8px;">Scenario:</label>
                    <select id="scenario-filter" class="btn" style="font-family: inherit;">
                        <option value="all">All Scenarios</option>
                        <option value="same" selected>Same Features</option>
                        <option value="population_mean">Population Mean</option>
                        <option value="artist_mean">Artist Mean</option>
                    </select>
                </div>
                {{ next_album_tables['known_table'] | safe }}
            </div>

            <div class="chart-container" id="new-predictions">
                <div class="chart-header">
                    <span class="chart-title">New Artist Predictions</span>
                </div>
                {{ next_album_tables['new_table'] | safe }}
            </div>
            {% else %}
            <div class="not-found">
                No prediction data available.
            </div>
            {% endif %}

            {% elif active_view == 'artist' %}
            {# Artist-specific view #}
            <h2 style="padding: 20px 0 10px; color: var(--text-muted); font-weight: normal;">
                Artist: {{ artist_name }}
            </h2>

            {% if artist_chart %}
            <div class="chart-container" id="artist-chart">
                <div class="chart-header">
                    <span class="chart-title">Album Score History</span>
                    <a href="/export/artist/{{ artist_name }}?format=png" class="btn">Download</a>
                </div>
                {{ artist_chart | safe }}
            </div>
            {% else %}
            <div class="not-found">
                Artist "{{ artist_name }}" not found in data.
            </div>
            {% endif %}

            {% else %}
            {# Default fallback #}
            <div class="not-found">
                Select a view from the sidebar.
            </div>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Scenario filter for next-album predictions
    (function() {
        var filter = document.getElementById('scenario-filter');
        if (filter) {
            function applyFilter() {
                var selected = filter.value;
                var table = document.getElementById('known-predictions-table');
                if (!table) return;
                var rows = table.querySelectorAll('tbody tr');
                rows.forEach(function(row) {
                    if (selected === 'all' || row.dataset.scenario === selected) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
            filter.addEventListener('change', applyFilter);
            // Apply default filter on load
            applyFilter();
        }
    })();

    // Table sorting functionality
    document.querySelectorAll('.coefficient-table th').forEach(function(header) {
        header.addEventListener('click', function() {
            const table = this.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const columnIndex = Array.from(this.parentNode.children).indexOf(this);
            const sortType = this.dataset.sort || 'string';

            // Determine sort direction
            const currentDir = this.dataset.sortDir || 'asc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';

            // Reset all headers
            table.querySelectorAll('th').forEach(h => h.dataset.sortDir = '');
            this.dataset.sortDir = newDir;

            // Sort rows
            rows.sort(function(a, b) {
                const cellA = a.children[columnIndex];
                const cellB = b.children[columnIndex];

                let valueA, valueB;

                if (sortType === 'number') {
                    valueA = parseFloat(cellA.dataset.value || cellA.textContent);
                    valueB = parseFloat(cellB.dataset.value || cellB.textContent);
                } else {
                    valueA = cellA.textContent.toLowerCase();
                    valueB = cellB.textContent.toLowerCase();
                }

                if (valueA < valueB) return newDir === 'asc' ? -1 : 1;
                if (valueA > valueB) return newDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Re-append sorted rows
            rows.forEach(function(row) {
                tbody.appendChild(row);
            });
        });
    });
</script>
{% endblock %}
